name: Renovate Bot

on:
  # Run on push to master (after PR merge or direct push)
  push:
    branches:
      - master
      - main
    paths:
      - 'renovate-config.js'
      - '.github/workflows/renovate.yml'
  
  # Run on pull requests to master/main
  pull_request:
    branches:
      - master
      - main
    paths:
      - 'renovate-config.js'
      - '.github/workflows/renovate.yml'
  
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: false
        default: 'info'
        type: choice
        options:
          - info
          - debug
      dryRun:
        description: 'Dry run (no PRs created)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  renovate:
    name: Renovate Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get GitHub App Token
        id: get_token
        uses: actions/create-github-app-token@v2
        with:
          private-key: ${{ secrets.RENOVATE_PRIVATE_KEY }}
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          owner: ${{ github.repository_owner }}
          # Authenticate for all repos the app has access to
          # To limit to specific repos, uncomment and list them:
          # repositories: |
          #   UYR-WEB-INFRA
          #   another-repo

      - name: Self-hosted Renovate
        uses: renovatebot/github-action@v44.0.4
        with:
          configurationFile: renovate-config.js
          token: '${{ steps.get_token.outputs.token }}'
        env:
          # Set log level (info or debug for troubleshooting)
          LOG_LEVEL: ${{ inputs.logLevel || 'info' }}
          # Optional: Enable dry run mode for testing
          RENOVATE_DRY_RUN: ${{ inputs.dryRun || 'false' }}
          # Pass the token for private package authentication
          RENOVATE_TOKEN: '${{ steps.get_token.outputs.token }}'

      - name: Renovate Summary
        if: always()
        run: |
          echo "## Renovate Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Log Level**: ${{ inputs.logLevel || 'info' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dryRun || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the Actions logs for details about dependency updates." >> $GITHUB_STEP_SUMMARY
